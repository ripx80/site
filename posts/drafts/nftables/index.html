<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><script type=text/javascript src=https://latest.cactus.chat/cactus.js></script><link rel=stylesheet href=https://latest.cactus.chat/style.css type=text/css><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>| ripx80 onexec</title>
<link rel=canonical href=https://ripx80.de/posts/drafts/nftables/><meta name=description content="ripx80 technical thoughts and try to memorize yesterday"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content><meta property="og:description" content="nftables system: x86_64 kernel: 6.7.9 date: 2024-04 nftables: 1.0.9
nftables is the modern Linux kernel (>= 3.13 nft support) packet classification framework to replace iptables.
short here you will get the basic and usefull cmd for nftables and some usecases how nftables will configured specialized on nixos systems. when you will dive deep and get some additional ideas look at (50 things to do with nftables)
netfilter The netfilter project enables packet filtering, network address [and port] translation (NA[P]T), packet logging, userspace packet queueing and other packet mangling."><meta property="og:type" content="article"><meta property="og:url" content="https://ripx80.de/posts/drafts/nftables/"><meta property="article:section" content="posts"><meta name=twitter:card content="summary"><meta name=twitter:title content><meta name=twitter:description content="nftables system: x86_64 kernel: 6.7.9 date: 2024-04 nftables: 1.0.9
nftables is the modern Linux kernel (>= 3.13 nft support) packet classification framework to replace iptables.
short here you will get the basic and usefull cmd for nftables and some usecases how nftables will configured specialized on nixos systems. when you will dive deep and get some additional ideas look at (50 things to do with nftables)
netfilter The netfilter project enables packet filtering, network address [and port] translation (NA[P]T), packet logging, userspace packet queueing and other packet mangling."><link rel=stylesheet href=https://ripx80.de/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://ripx80.de/css/custom.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://ripx80.de/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>home</a></li><li><a href=/posts>writings</a></li><li><a href=/lib>lib</a></li><li><a href=/tags>tags</a></li><li><a href=/whoami>whoami</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://ripx80.de/lib/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=https://ripx80.de/posts/kernel-compiling/ aria-label=Next><i class="fas fa-chevron-right" aria-hidden=true onmouseover='$("#i-next").toggle()' onmouseout='$("#i-next").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&text=" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&title=" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&is_video=false&description=" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=&body=Check out this article: https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&title=" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&title=" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&name=&description=nftables%20system%3a%20x86_64%20kernel%3a%206.7.9%20date%3a%202024-04%20nftables%3a%201.0.9%0anftables%20is%20the%20modern%20Linux%20kernel%20%28%26gt%3b%3d%203.13%20nft%20support%29%20packet%20classification%20framework%20to%20replace%20iptables.%0ashort%20here%20you%20will%20get%20the%20basic%20and%20usefull%20cmd%20for%20nftables%20and%20some%20usecases%20how%20nftables%20will%20configured%20specialized%20on%20nixos%20systems.%20when%20you%20will%20dive%20deep%20and%20get%20some%20additional%20ideas%20look%20at%20%2850%20things%20to%20do%20with%20nftables%29%0anetfilter%20The%20netfilter%20project%20enables%20packet%20filtering%2c%20network%20address%20%5band%20port%5d%20translation%20%28NA%5bP%5dT%29%2c%20packet%20logging%2c%20userspace%20packet%20queueing%20and%20other%20packet%20mangling." aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&t=" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline"></h1><div class=meta><div class=postdate><time datetime="0001-01-01 00:00:00 +0000 UTC" itemprop=datePublished>0001-01-01</time></div><div class=article-read-time><i class="far fa-clock"></i>
17 minute read</div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#short>short</a></li><li><a href=#netfilter>netfilter</a></li><li><a href=#nft>nft</a></li><li><a href=#families>families</a></li><li><a href=#nft-debugging>nft debugging</a></li><li><a href=#nftrace>nftrace</a></li><li><a href=#nftables-with-nixos>nftables with nixos</a><ul><li><a href=#nat>nat</a></li><li><a href=#wg-restrictions>wg restrictions</a></li></ul></li><li><a href=#logging-traffic>logging traffic</a></li><li><a href=#icmp>icmp</a></li><li><a href=#limits>limits</a></li><li><a href=#flowtables>flowtables</a></li><li><a href=#simple-ruleset-for-a-wg-router>simple ruleset for a wg router</a></li><li><a href=#todo-use-the-new-if-layout-from-wgpx-add-flowtables-for-wg---wg>todo: use the new if layout from wgpx, add flowtables for wg &lt;-> wg</a></li><li><a href=#learned>learned</a></li><li><a href=#docs>docs</a></li><li><a href=#todo>todo</a></li><li><a href=#how-to-check-rules-are-correct-and-working>how to check rules are correct and working?</a></li><li><a href=#counting-https>counting https</a></li></ul></nav></div><div class=content itemprop=articleBody><h1 id=nftables>nftables</h1><p>system: x86_64
kernel: 6.7.9
date: 2024-04
nftables: 1.0.9</p><p>nftables is the modern Linux kernel (>= 3.13 nft <a href="https://git.netfilter.org/nftables/log/doc?showmsg=1">support</a>) packet classification framework to replace iptables.</p><h2 id=short>short</h2><p>here you will get the basic and usefull cmd for nftables and some usecases how nftables will configured specialized on nixos systems.
when you will dive deep and get some additional ideas look at (50 things to do with nftables)</p><h2 id=netfilter>netfilter</h2><p>The netfilter project enables packet filtering, network address [and port] translation (NA[P]T), packet logging, userspace packet queueing and other packet mangling.</p><p>The netfilter hooks are a framework inside the Linux kernel that allows kernel modules to register callback functions at different locations of the Linux network stack. The registered callback function is then called back for every packet that traverses the respective hook within the Linux network stack.</p><p>So, netfilter is the Linux framework for manipulating network packets. It can filter and transform packets at predefined points in the kernel.</p><p>On top of netfilter sit the firewalls: the venerable iptables, and the new nftables</p><h2 id=nft>nft</h2><p>some useful commands to interact with nftables and netfilter.
Note that the position of the statements within your rule is significant,
because nftables evaluates expressions and statements linearly from left to right.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nft --stateless list table filter <span style=color:#75715e># list table filter, omit stateful information like counters</span>
</span></span><span style=display:flex><span>nft --stateless list ruleset <span style=color:#75715e># list all nft instructions</span>
</span></span><span style=display:flex><span>nft list chains <span style=color:#75715e># list all chains</span>
</span></span><span style=display:flex><span>nft -j list ruleset <span style=color:#75715e># output json</span>
</span></span><span style=display:flex><span>nft list ruleset -a <span style=color:#75715e># get the handle to delte a rule</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nft delete rule inet nixos-fw input-allow handle <span style=color:#ae81ff>17</span> <span style=color:#75715e># delete rule in nixos-fw chain input-allow handle 17</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nft -c -o -f ruleset.test  <span style=color:#75715e>#  read the nft file, optimize ruleset in dry-run mode</span>
</span></span><span style=display:flex><span>nft monitor <span style=color:#75715e># see live changes on ruleset</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># change policy of a chain</span>
</span></span><span style=display:flex><span>nft add ip chain nat PREROUTING <span style=color:#e6db74>&#39;{ policy drop; }&#39;</span> <span style=color:#75715e># add chain PREROUTING with default policy drop</span>
</span></span><span style=display:flex><span>nft add chain ip nat POSTROUTING <span style=color:#e6db74>&#39;{ policy accept; }&#39;</span> <span style=color:#75715e># add chain nat POSTROUTING with default policy accept</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=families>families</h2><p>nft has different family types to interact with:</p><ul><li>ip: only see ipv4 traffic</li><li>ip6: only see ipv6 traffic</li><li>inet: Tables of this family see both IPv4 and IPv6 traffic/packets, simplifying dual stack support.</li><li>arp: arp level traffic</li><li>bridge: traffic/packets traversing bridges</li><li>netdev: The netdev family is different from the others in that it is used to create base chains attached to a single network interface. Such base chains see all network traffic on the specified interface, with no assumptions about L2 or L3 protocols.</li></ul><h2 id=nft-debugging>nft debugging</h2><p>with <code>sh nft monitor</code> you can see live rules changes
todo: more input and examples</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nft monitor
</span></span></code></pre></td></tr></table></div></div><h2 id=nftrace>nftrace</h2><p>todo: more input and examples</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nft monitor trace
</span></span></code></pre></td></tr></table></div></div><h2 id=nftables-with-nixos>nftables with nixos</h2><p>nixos: 23.11
nixos modules:</p><ul><li><a href=https://github.com/NixOS/nixpkgs/blob/nixos-23.11/nixos/modules/services/networking/firewall.nix>firewall</a></li><li><a href=https://github.com/NixOS/nixpkgs/blob/nixos-23.11/nixos/modules/services/networking/firewall-nftables.nix>firewall-nftables</a></li><li><a href=https://github.com/NixOS/nixpkgs/blob/nixos-23.11/nixos/modules/services/networking/nftables.nix>nftables</a></li></ul><p>nftables can be enabled with the nixos setting <code>nix network.nftables.enable = true;</code>. This will add the <strong>pkgs.nftables</strong> to your system environment and create a default ruleset for your system.</p><pre tabindex=0><code class=language-nft data-lang=nft># default name nixos-fw, inet is for ipv4 and ipv6 traffic
table inet nixos-fw {
    # chain for reverse path filtering and dhcp
    chain rpfilter {
        # this will change the priority of mangle to 10 and a default chain policy to drop
        type filter hook prerouting priority mangle + 10; policy drop;
        # this will open dhcpv4 on port 68 and 67 bootp
        meta nfproto ipv4 udp sport . udp dport { 68 . 67, 67 . 68 } accept comment &#34;DHCPv4 client/server&#34;
        # check reverse path, see cfg.checkReversePath
        fib saddr . mark . iif oif exists accept
    }
    # default input chain
    chain input {
        # filter with default drop policy
        type filter hook input priority filter; policy drop;
        # lo is a trusted interface, see networking.firewall.trustedInterfaces
        iifname &#34;lo&#34; accept comment &#34;trusted interfaces&#34;
        # track the state of the conntrack, new and untracked will handled in input-allow
        ct state vmap { invalid : drop, established : accept, related : accept, new : jump input-allow, untracked : jump input-allow }
    }
    # allow dhcpv6 without any trusted ports defined in networking.firewall.allowedTCPPorts
    chain input-allow {
        icmpv6 type != { nd-redirect, 139 } accept comment &#34;Accept all ICMPv6 messages except redirects and node information queries (type 139).  See RFC 4890, section 4.4.&#34;
        ip6 daddr fe80::/64 udp dport 546 accept comment &#34;DHCPv6 client&#34;
    }
}
</code></pre><p>this is the default ruleset when nftables is enabled on a nixos system.
you can see the function of each instruction in the comments or look into the nixos modules.
other interesting options can find under ```nix network.firewall``:</p><ul><li>logReversePathDrops</li><li>logRefusedConnections</li><li>logRefusedPackets</li><li>logRefusedUnicastsOnly</li><li>rejectPackets</li><li>allowPing</li><li>pingLimit</li></ul><p>this is my default configuration without overwrite the entire ruleset and use the nixos modules options:</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>networking <span style=color:#960050;background-color:#1e0010>=</span> {
</span></span><span style=display:flex><span>  firewall <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      logRefusedConnections <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      logRefusedPackets <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      allowPing <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      interfaces<span style=color:#f92672>.</span>eth0 <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        <span style=color:#75715e># my wireguard port ready to connect to the outside world.</span>
</span></span><span style=display:flex><span>        allowedUDPPorts <span style=color:#f92672>=</span> [ meta<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>config<span style=color:#f92672>.</span>networking<span style=color:#f92672>.</span>hostName<span style=color:#e6db74>}</span><span style=color:#f92672>.</span>wg<span style=color:#f92672>.</span>port ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>      <span style=color:#75715e># on wg only ssh and dns are open</span>
</span></span><span style=display:flex><span>      interfaces<span style=color:#f92672>.</span>wg0 <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>        allowedTCPPorts <span style=color:#f92672>=</span> [ <span style=color:#ae81ff>22</span> <span style=color:#ae81ff>53</span> ];
</span></span><span style=display:flex><span>        allowedUDPPorts <span style=color:#f92672>=</span> [ <span style=color:#ae81ff>53</span> ];
</span></span><span style=display:flex><span>      };
</span></span><span style=display:flex><span>    };
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><h3 id=nat>nat</h3><p>network address translation (<a href=https://wiki.nftables.org/wiki-nftables/index.php/Performing_Network_Address_Translation_(NAT)>nat</a>) will allow you to route packets to different networks.
i will use this to allow my wireguard clients the connection to the outside world via eth0, so you can build your own vpn server with masquerading.
the first step is to enable packet forwarding in the kernel.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sysctl --system
</span></span><span style=display:flex><span>net.ipv4.conf.all.forwarding <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>net.ipv4.conf.default.forwarding <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>
</span></span></code></pre></td></tr></table></div></div><p>in nixos you can do that by set this via sysctl.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>boot<span style=color:#f92672>.</span>kernel<span style=color:#f92672>.</span>sysctl <span style=color:#960050;background-color:#1e0010>=</span> {
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;net.ipv4.conf.all.forwarding&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#34;net.ipv4.conf.default.forwarding&#34;</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>};
</span></span></code></pre></td></tr></table></div></div><p>normaly nixos has an option for that <code>nix networking.nat.enable = true;</code> but this will accept all forwarded packets to every network interface.
you can change this behavoir with <code>nix networking.firewall.filterForward</code>.
this will create a <strong>forward</strong> and <strong>forward-allow</strong> chain but i will use the<code>nix networking.nftables.ruleSet</code> to set the rules in one place.</p><p>to route internal traffic (wg0) to the outside (eth0) you need two tables: <strong>nat</strong> and <strong>forward</strong>.
here are the nft rules to enable a simple source nat with masquerading from wg0 to eth0. All addresses in this network will be forwarded.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>nftables <span style=color:#960050;background-color:#1e0010>=</span> {
</span></span><span style=display:flex><span>    enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    flushRuleset <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>; <span style=color:#75715e># flush all tables on reload</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># rules are addaptive with nixos-fw.</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># if you have a table this rules will added or change the ruleset like the default policy of a chain.</span>
</span></span><span style=display:flex><span>    ruleset <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    # the nat table will configure how packages are translated (srcnat, dstnat, aso)
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    table ip nat {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        chain postrouting {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # this will add the srcnat postrouting hook
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        type nat hook postrouting priority srcnat; policy accept;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # input interface is the internal wireguard network wg0.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # output interface is eth0 which is connected to the internet.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # the source nat will be masquerade, only the ip address of your router will shown to the outside
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        iifname &#34;wg0&#34; oifname &#34;eth0&#34; masquerade comment &#34;from internal interfaces&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    table ip filter {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # need a forward chain to forward incomming packets
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        chain forward {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            type filter hook forward priority 0; policy drop;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            # only new connections from wg0 to eth0 forwarding are accepted
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            iifname &#34;wg0&#34; oifname &#34;eth0&#34; accept comment &#34;only from wg0 to internet&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            # you need the reverse path for your packages, so only allow related and ethablished packts from the internet
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            iifname &#34;eth0&#34; oifname &#34;wg0&#34; ct state related,established accept comment &#34;allow responses from internet&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#39;&#39;</span>;
</span></span><span style=display:flex><span>  };
</span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>}</span>;
</span></span></code></pre></td></tr></table></div></div><p>But if you have some special clients they should be forwarded and all others are in prision inside your wg network you can add these specific ip addresses to a allow list instead of allow all clients this privilege.</p><pre tabindex=0><code class=language-nft data-lang=nft> table ip filter {
    chain forward {
        # disable &#34;all&#34; forwarding rule
        # iifname &#34;wg0&#34; oifname &#34;eth0&#34; accept comment &#34;only from wg0 to internet&#34;
        # add source address to forward
        ip saddr { 192.168.1.2, 192.168.1.3, 192.168.1.43 } oifname &#34;eth0&#34; accept comment &#34;only specified source ip to internet&#34;
        iifname &#34;wg0&#34; oifname &#34;wg0&#34; jump wg-forward
    }
 }
</code></pre><h3 id=wg-restrictions>wg restrictions</h3><p>maybe you will restrict clients inside your wireguard network to talk to each other or to be explicit do the initial connection.
the following ruleset will allow the ip address 192.168.1.2 etablish a new connection to ip addresses 192.168.1.3 and 192.168.1.43.
192.168.1.3 can only etablish a new connection to .43.
The vmap on the beginning take care of the response, etablished and related are accepted.
if you want to read more in detail informations about <a href=https://wiki.nftables.org/wiki-nftables/index.php/Verdict_Maps_(vmaps)>verdict map</a>.</p><pre tabindex=0><code class=language-nft data-lang=nft>chain wg-forward {
    # here the state will be set in a vmap
    ct state vmap { invalid : drop, established : accept, related : accept }
    ip saddr 192.168.1.2 ip daddr { 192.168.1.3, 192.168.1.43 } accept
    ip saddr 192.168.1.3 ip daddr { 192.168.1.2 } accept
}
</code></pre><h2 id=logging-traffic>logging traffic</h2><p>sometimes you will log important connections in your logging system like ssh login attemps.
we use the default <strong>nixos-fw</strong> table to log a new incomming ssh connection.
this will log all new ssh connections in your kernel log.</p><pre tabindex=0><code class=language-nft data-lang=nft>table inet nixos-fw {
    chain input-allow {
        tcp dport 22 ct state new log prefix &#34;[nftables] new ssh accepted: &#34; accept comment &#34;allow and log ssh&#34;
    }
}
</code></pre><p>or if you want to use the command line to add this rule, use the nft cmd.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nft add rule inet nixos-fw input-allow tcp dport <span style=color:#ae81ff>22</span> ct state new log prefix <span style=color:#ae81ff>\&#34;</span><span style=color:#f92672>[</span>nftables<span style=color:#f92672>]</span> new ssh accepted: <span style=color:#ae81ff>\&#34;</span> accept comment <span style=color:#e6db74>&#34;allow and log ssh&#34;</span>
</span></span></code></pre></td></tr></table></div></div><p>normaly this logs are send to journald on most linux distributions and you can inspect these logs via journalctl.
the default priority is <strong>4</strong> for nftables logs if you have not set another priority.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>journalctl -k --priority<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> <span style=color:#75715e># show priority level 4 like nftables</span>
</span></span></code></pre></td></tr></table></div></div><p>when you connected to the internet you will see a lot of login attempts to your ssh port. yes we a live in a bad world, because bots and scanners try to login or check your open ports.
but we dont have allow ssh on the interface <strong>eth0</strong>, have we? yes you have an accept in this rule and set no interface.
so this will open your ssh service on all interfaces!
but we want to allow ssh etablish new connections only on the internal wg0 network.</p><pre tabindex=0><code class=language-nft data-lang=nft>iif &#34;wg0&#34; tcp dport 22 ct state new log prefix &#34;[nftables] new ssh connection: &#34; accept
</code></pre><p>now only ssh connections on the internal wireguard interface &ldquo;wg0&rdquo; are allowed. you can verify this in the kernel log or try to connect with a ssh client to eth0 and wg0.</p><h2 id=icmp>icmp</h2><p>its a good idea to rate limit the icmp echo-request (ping) on a machine to prevent ping-floods.</p><pre tabindex=0><code class=language-nft data-lang=nft>table inet nixos-fw {
    chain input-allow {
        icmp type echo-request limit rate 10/second accept
    }
}
</code></pre><h2 id=limits>limits</h2><pre tabindex=0><code class=language-nft data-lang=nft>     #limit lim_400ppm { rate 400/minute ; comment &#34;limit per packet&#34;}
</code></pre><p>limit ssh connections per ip and counter</p><pre tabindex=0><code class=language-nft data-lang=nft>iif $ssh tcp dport 22 meter ssh_meter { ip saddr ct count over 5 } counter drop comment &#34;limit ssh max connections per ip&#34;
</code></pre><h2 id=flowtables>flowtables</h2><p><a href=https://wiki.nftables.org/wiki-nftables/index.php/Flowtables>flowtables</a> allow you to accelerate packet forwarding in software (and in hardware if your nic supports it) by using a conntrack-based network stack bypass.
for example you can skip the default flow of rules and use the ingress flow and then redirect directly to the forward chain, too speed up your routing.</p><p>on nixos you must disable <code>nix networking.nftables.checkRuleset = false;</code> because the ruleset checker will not work with flowtables at the <a href=https://discourse.nixos.org/t/nftables-could-not-process-rule-no-such-file-or-directory/33031>moment</a>.</p><p>in this example the flow will go from <strong>wg0</strong> to <strong>enp10s0</strong> direct from ingress to forward for tcp and upd traffic.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>
</span></span><span style=display:flex><span> table inet filter {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    flowtable ft {
</span></span><span style=display:flex><span>        hook ingress priority <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>        devices <span style=color:#f92672>=</span> { wg0<span style=color:#f92672>,</span> enp10s0 }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    chain forward {
</span></span><span style=display:flex><span>        type filter hook forward priority <span style=color:#ae81ff>0</span>; policy drop;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># enable flow offloading for better throughput</span>
</span></span><span style=display:flex><span>        ip protocol { tcp<span style=color:#f92672>,</span> udp } ct state established flow offload <span style=color:#f92672>@</span>ft counter
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>note that when you use flowtables the hooks prerouting and postrouting are bypassed. you canot use a feature like masquerade with this fastpath.
a deep explaination of this topic you can find on this <a href="https://thermalcircle.de/doku.php?id=blog:linux:flowtables_1_a_netfilter_nftables_fastpath">blog</a> post.</p><h2 id=simple-ruleset-for-a-wg-router>simple ruleset for a wg router</h2><p>normaly when i have more advanced ruleset i overwrite all default nixos rules with a <code>nix nftables.ruleset</code> and <code>nft flush ruleset</code>.
this is a blueprint for a minimal nat wg router to enable routing between wireguard nodes (internal wg0) and the internet (vpn mode).
I use <a href="https://wiki.nftables.org/wiki-nftables/index.php/Scripting#:~:text=%22/etc/nftables/*%22-,Defining%20variables,-You%20can%20use">define</a> to set variables for a clean ruleset.</p><p>if you see <code>nix ${meta.ripbox.wg.ip}</code> this means that i define the ip and other host related information in one <a href=https://github.com/AGWA/git-crypt>git-crypt</a> meta.nix file in my repository.</p><p>here are some features:</p><ul><li>flush ruleset</li><li>nftables scripting</li><li>named counters</li><li>named limits</li><li>limit max ssh connections from src_ip</li><li>limits max conections in time</li><li>reverse path filtering (default from nixos)</li><li>blocking list (fail2ban replacement)</li><li>log ssh connection to kernel log</li><li>source nat and masquerading (vpn)</li><li>forward specific wireguard clients to each other</li><li>ingress filter to drop bad packages like XMAS, SYN Flood, aso</li></ul><h2 id=todo-use-the-new-if-layout-from-wgpx-add-flowtables-for-wg---wg>todo: use the new if layout from wgpx, add flowtables for wg &lt;-> wg</h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">  9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 96
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 97
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 98
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 99
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">100
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">101
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">102
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">103
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">104
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">105
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">106
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">107
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">108
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">109
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">110
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">111
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">112
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">113
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">114
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">115
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">116
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">117
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">118
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">119
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-nix data-lang=nix><span style=display:flex><span>firewall<span style=color:#f92672>.</span>enable <span style=color:#960050;background-color:#1e0010>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>    nftables <span style=color:#960050;background-color:#1e0010>=</span> {
</span></span><span style=display:flex><span>      enable <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>;
</span></span><span style=display:flex><span>      checkRuleset <span style=color:#f92672>=</span> <span style=color:#66d9ef>false</span>;
</span></span><span style=display:flex><span>      ruleset <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # delete all prev rules like nixos default rules
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        flush ruleset
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define if_in = wg0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define if_out = eth0
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define if_wg  = { $if_out }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define wg_port = </span><span style=color:#e6db74>${</span>builtins<span style=color:#f92672>.</span>toString meta<span style=color:#f92672>.</span><span style=color:#e6db74>${</span>config<span style=color:#f92672>.</span>networking<span style=color:#f92672>.</span>hostName<span style=color:#e6db74>}</span><span style=color:#f92672>.</span>wg<span style=color:#f92672>.</span>port<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define ssh = { $if_in }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define dns = { $if_in }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define ripbox = </span><span style=color:#e6db74>${</span>meta<span style=color:#f92672>.</span>ripbox<span style=color:#f92672>.</span>wg<span style=color:#f92672>.</span>ip<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define ripmc  = </span><span style=color:#e6db74>${</span>meta<span style=color:#f92672>.</span>ripmc<span style=color:#f92672>.</span>wg<span style=color:#f92672>.</span>ip<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define ripwin = </span><span style=color:#e6db74>${</span>meta<span style=color:#f92672>.</span>ripwin<span style=color:#f92672>.</span>wg<span style=color:#f92672>.</span>ip<span style=color:#e6db74>}</span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # here i define the internal network with hosts to talk to each other
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define frostnet = { $ripbox, $ripmc, $ripwin }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        # here i define the hosts they can use this server as a vpn router to forward packages to the internet.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        define vpn_allow = { $ripbox, $ripmc, $ripmob }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        table inet fw {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            counter cnt_ssh {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                comment &#34;count ssh packets&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            counter cnt_dns {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                comment &#34;count dns packets&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            counter cnt_dns_tcp {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                comment &#34;count dns over tcp packets&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            limit lim_ssh { rate over 10/minute }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            limit lim_icmp { rate 10/second ; comment &#34;no ping floods&#34;}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            limit lim_dns { rate 150/second ; comment &#34;no dns floods&#34; }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            set deny_v4 { type ipv4_addr ; flags dynamic, timeout ; timeout 5m ; comment &#34;deny list of blocked ip addresses&#34;;}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            chain rpfilter {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                type filter hook prerouting priority mangle + 10; policy drop;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                fib saddr . mark . iif oif exists accept comment &#34;reverse path check&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            chain input {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                type filter hook input priority 0; policy drop;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                iif lo accept comment &#34;trusted interfaces&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ip saddr @deny_v4 drop comment &#34;drop all clients from blocking list&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                icmp type echo-request limit name lim_icmp counter accept comment &#34;No ping floods and allow pings&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ct state vmap { invalid : drop, established : accept, related : accept, new : jump services, untracked : jump services }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            chain output {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                type filter hook output priority 0; policy drop;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ct state vmap { invalid : drop, established : accept, related : accept, new : accept, untracked : accept } comment &#34;allow outgoing packages&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            chain services {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                iif $if_wg udp dport $wg_port accept comment &#34;open wg port&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                iif $ssh tcp dport 22 ct state new, untracked limit name lim_ssh update @deny_v4 { ip saddr } comment &#34;limit ssh connection in time to blocking list&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                iif $ssh tcp dport 22 meter ssh_meter { ip saddr ct count over 5 } counter drop comment &#34;limit ssh max connections per ip&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                iif $ssh tcp dport 22 ct state new counter name cnt_ssh log prefix &#34;[nftables] new ssh connection: &#34; accept comment &#34;allow, log, count new ssh connections&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                iif $dns udp dport 53 limit name lim_dns counter name cnt_dns accept comment &#34;limit dns queries on interface&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                iif $dns tcp dport 53 limit name lim_dns counter name cnt_dns_tcp accept comment &#34;limit dns queries on interface&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        table inet nat {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            chain postrouting {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                type nat hook postrouting priority srcnat; policy accept;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                iif $if_in oif $if_out masquerade comment &#34;from internal interfaces&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        table inet vpn {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            chain forward {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                type filter hook forward priority 0; policy drop;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ct state vmap { invalid : drop, established : accept, related : accept }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ip saddr { $ripbox, $ripmc, $ripmob } oif $if_out accept comment &#34;only specified source ip to internet&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                iif $if_out oif $if_in ct state related,established accept comment &#34;allow responses from internet&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                iif $if_in oif $if_in jump wg-forward comment &#34;allow internal routing&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            chain wg-forward {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ip saddr $ripbox ip daddr $frostnet accept
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ip saddr $ripmc ip daddr $frostnet accept
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ip saddr $ripwin ip daddr { $ripmc } accept
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        table netdev filter {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            chain ingress {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                type filter hook ingress devices = {$if_in, $if_out} priority -500
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                jump ingress_filter
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            # Basic filter chain, devices can be configued to jump here
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            chain ingress_filter {
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                ip frag-off &amp; 0x1fff != 0 counter drop comment &#34;drop all fragments&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                tcp flags fin,psh,urg / fin,psh,urg counter packets 0 bytes 0 drop comment &#34;drop xmas nmap packets&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                tcp flags &amp; (fin|syn|rst|psh|ack|urg) == fin|syn|rst|psh|ack|urg counter drop comment &#34;drop xmas packets&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                tcp flags &amp; (fin|syn|rst|psh|ack|urg) == 0x0 counter drop comment &#34;drop null packets&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                tcp flags syn tcp option maxseg size 1-535 counter drop comment &#34;drop uncommon mss values&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                tcp flags &amp; (fin|syn) == (fin|syn) counter drop comment &#34;drop fin and syn at the same time&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                tcp flags &amp; (syn|rst) == (syn|rst) counter drop comment &#34;drop rst and syn at the same time&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#39;&#39;</span>;
</span></span><span style=display:flex><span>      };
</span></span></code></pre></td></tr></table></div></div><h2 id=learned>learned</h2><ul><li><p><a href=https://www.kernel.org/doc/Documentation/networking/ip-sysctl.txt>doc</a>:
Difference between net.ipv4.conf.all.forwarding and net.ipv4.ip_forward.</p></li><li><p>sysctl &ndash;system shows all system settings without a config file</p></li><li><p>ip mangle table: It is basically used to set specific headers for IP packets to affect the routing decision made further on. like mtu or ttl.</p></li><li><p>nixos opens automaticly dhcp ipv4 and ipv6 ports when networking.firewall.enable = true.</p></li><li><p>nixos networking.firewall.checkReversePath is default true</p></li><li><p>postrouting:</p></li><li><p>prerouting:</p></li><li><p>masquerade: Masquerade is a special case of SNAT, where the source address is automagically set to the address of the output interface.</p></li><li><p>redirect: By using redirect, packets will be forwarded to local machine. Is a special case of DNAT where the destination is the current machine.</p></li><li><p>netcat host port (tcp connection)</p></li><li><p>netcat -u host port (udp connection)</p></li><li><p>netcat -z -v domain.com 1-1000 # port scanning</p></li><li><p>netcat -l 4444 # listen</p></li><li><p>netcat -l 4444 > received_file # files through</p></li><li><p>netcat domain.com 4444 &lt; original_file</p></li><li><p>printf &lsquo;HTTP/1.1 200 OK\n\n%s&rsquo; &ldquo;$(cat index.html)&rdquo; | netcat -l 8888 # http://server_IP:8888</p></li><li><p>${pkgs.iproute}/bin/ip link set mtu 1400 dev wg0</p></li><li><p>journalctl -f read on the fly, journalctl -k only kernel messages like nftables, journal -k &ndash;priority=4 (show priority level 4 like nftables)</p></li><li><p>tcpdump -i eth0 host ip-95-223-229-27.hsi16.unitymediagroup.de and not port 58432</p></li></ul><h2 id=docs>docs</h2><ul><li><a href=https://wiki.nftables.org/wiki-nftables/index.php/Main_Page>wiki</a></li><li><a href="https://git.netfilter.org/nftables/log/doc?showmsg=1">timeline log</a> of nft development</li><li>in <a href=https://wiki.nftables.org/wiki-nftables/index.php/Quick_reference-nftables_in_10_minutes>10 minutes</a></li><li><a href=https://scvalex.net/posts/54/>nftables on nixos</a></li><li><a href=https://wiki.nftables.org/wiki-nftables/index.php/Flowtables>flowtables</a></li><li><a href=https://docs.kernel.org/networking/nf_flowtable.html>flowtables kernel</a></li><li><a href="https://thermalcircle.de/doku.php?id=blog:linux:flowtables_1_a_netfilter_nftables_fastpath">deep explaination of flowtables</a></li><li><a href=https://francis.begyn.be/blog/nixos-home-router>nixos-home-router</a></li><li><a href=https://pavluk.org/blog/2022/01/26/nixos_router.html>nixos-router</a></li><li><a href=https://www.procustodibus.com/blog/2021/11/wireguard-nftables/>wireguard nftables</a></li></ul><h2 id=todo>todo</h2><ul><li><p>iif canot be used in checkRuleset in nixos use ifname instead</p></li><li><p>a way to log only valid ssh credentials logins?</p></li><li><p>The connection tracking system supports accounting, which means counting packets and bytes for each flow and for each flow direction. This feature is deactivated by default. You can activate it with this sysctl:
sysctl -w net.netfilter.nf_conntrack_acct=1
conntrack -L</p></li><li><p>#iif $if_in oif $if_out accept comment &ldquo;only from all clients in internal to internet&rdquo;</p></li><li><p>add per src_ip network counters like ssh or dns</p></li><li><p>counter for network traffic per src_ip</p></li><li><p>QoS with nftables?</p></li><li><p>loadbalancing nexthop</p></li><li><p>how can you test the speed of fw?</p></li></ul><h2 id=how-to-check-rules-are-correct-and-working>how to check rules are correct and working?</h2><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>ping -t &lt;target IP&gt; -l <span style=color:#ae81ff>65500</span> <span style=color:#75715e># ping flood</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>dog -U -n 192.168.100.1 google.de <span style=color:#75715e># test udp dns query</span>
</span></span><span style=display:flex><span>dog -T -n 192.168.100.1 google.de <span style=color:#75715e># test tcp dns query</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ssh 192.168.100.1 <span style=color:#75715e># ssh counter and log entry</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>nft list counters
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt><span style=display:flex><span>table inet fw {
</span></span><span style=display:flex><span>    counter cnt_ssh {
</span></span><span style=display:flex><span>        comment &#34;count ssh packets&#34;
</span></span><span style=display:flex><span>        packets 1 bytes 60
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    counter cnt_dns {
</span></span><span style=display:flex><span>        comment &#34;count dns packets&#34;
</span></span><span style=display:flex><span>        packets 1 bytes 66
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    counter cnt_dns_tcp {
</span></span><span style=display:flex><span>        comment &#34;count dns over tcp packets&#34;
</span></span><span style=display:flex><span>        packets 1 bytes 60
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>check for ssh log</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>journalctl -k --priority<span style=color:#f92672>=</span><span style=color:#ae81ff>4</span> | tail
</span></span></code></pre></td></tr></table></div></div><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>nmap -sN 192.168.100.1 -p22 <span style=color:#75715e># counter increase by two null packets</span>
</span></span><span style=display:flex><span>nmap -sF 192.168.100.1 -p22 <span style=color:#75715e># not in counter</span>
</span></span><span style=display:flex><span>nmap -sX 192.168.100.1 -p22 <span style=color:#75715e># counter increase by two xmas</span>
</span></span><span style=display:flex><span>nmap -sS --scanflags SYNFIN 192.168.100.1 -p22 <span style=color:#75715e># URG, ACK, PSH, RST, SYN, and FIN</span>
</span></span><span style=display:flex><span><span style=color:#75715e># no example found to send uncommon mss values</span>
</span></span></code></pre></td></tr></table></div></div><h2 id=counting-https>counting https</h2><pre tabindex=0><code class=language-nft data-lang=nft>table inet fw {
    set https { type ipv4_addr; flags dynamic; size 65536; timeout 60m; comment &#34;counter per ip https request&#34;;}
    chain input {
        type filter hook input priority 0; policy drop;
        tcp dport 443 accept
        ct state new tcp dport 443 update @https { ip saddr counter } comment &#34;count https requests&#34;
    }

}
</code></pre><p>nft list set inet filter https</p></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>home</a></li><li><a href=/posts>writings</a></li><li><a href=/lib>lib</a></li><li><a href=/tags>tags</a></li><li><a href=/whoami>whoami</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&text=" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&title=" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&is_video=false&description=" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=&body=Check out this article: https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&title=" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&title=" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&name=&description=nftables%20system%3a%20x86_64%20kernel%3a%206.7.9%20date%3a%202024-04%20nftables%3a%201.0.9%0anftables%20is%20the%20modern%20Linux%20kernel%20%28%26gt%3b%3d%203.13%20nft%20support%29%20packet%20classification%20framework%20to%20replace%20iptables.%0ashort%20here%20you%20will%20get%20the%20basic%20and%20usefull%20cmd%20for%20nftables%20and%20some%20usecases%20how%20nftables%20will%20configured%20specialized%20on%20nixos%20systems.%20when%20you%20will%20dive%20deep%20and%20get%20some%20additional%20ideas%20look%20at%20%2850%20things%20to%20do%20with%20nftables%29%0anetfilter%20The%20netfilter%20project%20enables%20packet%20filtering%2c%20network%20address%20%5band%20port%5d%20translation%20%28NA%5bP%5dT%29%2c%20packet%20logging%2c%20userspace%20packet%20queueing%20and%20other%20packet%20mangling." aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fripx80.de%2fposts%2fdrafts%2fnftables%2f&t=" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; ripx80</div><div class=footer-right><nav><ul><li><a href=/>home</a></li><li><a href=/posts>writings</a></li><li><a href=/lib>lib</a></li><li><a href=/tags>tags</a></li><li><a href=/whoami>whoami</a></li><li><a href=https://ripx80.de/legal>legal notice</a></li><li><a href=https://ripx80.de/privacy>pricacy policy</a></li></ul></nav></div></footer><div id=cookies>if you use this site you accept the usage of cookies. take a closer look under <a href=https://ripx80.de/privacy>privacy policy</a>
<button id=cookies-btn>accept</button></div><script src=https://ripx80.de/js/custom.js defer></script></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>