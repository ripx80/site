<!doctype html><html lang=en-us><head><link rel=preload href=/lib/font-awesome/webfonts/fa-brands-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-regular-400.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/font-awesome/webfonts/fa-solid-900.woff2 as=font type=font/woff2 crossorigin=anonymous><link rel=preload href=/lib/JetBrainsMono/web/woff2/JetBrainsMono-Regular.woff2 as=font type=font/woff2 crossorigin=anonymous><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><title>wireguard mtu calculation | ripx80 onexec</title>
<link rel=canonical href=https://ripx80.de/posts/06-wg-mtu/><meta name=description content="ripx80 technical thoughts and try to memorize yesterday"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content="all,follow"><meta name=googlebot content="index,follow,snippet,archive"><meta property="og:title" content="wireguard mtu calculation"><meta property="og:description" content="wireguard header overhead and the connection problems with your cutted off mtu by your isp"><meta property="og:type" content="article"><meta property="og:url" content="https://ripx80.de/posts/06-wg-mtu/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2024-06-27T00:00:00+00:00"><meta property="article:modified_time" content="2024-06-27T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="wireguard mtu calculation"><meta name=twitter:description content="wireguard header overhead and the connection problems with your cutted off mtu by your isp"><link rel=stylesheet href=https://ripx80.de/css/styles.94f653e9e151e28067a7c5dbbc4600cbd5a3c721e79faaf971e523c40f3b249b8e4f20bb57810dfffa8d559ca5c140fd56eb4cd9c0853113ad08e66afdb08bdd.css integrity="sha512-lPZT6eFR4oBnp8XbvEYAy9WjxyHnn6r5ceUjxA87JJuOTyC7V4EN//qNVZylwUD9VutM2cCFMROtCOZq/bCL3Q=="><link rel=stylesheet href=https://ripx80.de/css/custom.css><!--[if lt IE 9]><script src=https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js></script><script src=https://oss.maxcdn.com/respond/1.4.2/respond.min.js></script><![endif]--><link rel=icon type=image/png href=https://ripx80.de/images/favicon.ico></head><body class="max-width mx-auto px3 ltr"><div class="content index py4"><div id=header-post><a id=menu-icon href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=menu-icon-tablet href=#><i class="fas fa-bars fa-lg"></i></a>
<a id=top-icon-tablet href=# onclick='$("html, body").animate({scrollTop:0},"fast")' style=display:none aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg"></i></a>
<span id=menu><span id=nav><ul><li><a href=/>home</a></li><li><a href=/posts>writings</a></li><li><a href=/lib>lib</a></li><li><a href=/tags>tags</a></li><li><a href=/whoami>whoami</a></li></ul></span><br><span id=actions><ul><li><a class=icon href=https://ripx80.de/posts/05-nftables-router/ aria-label=Previous><i class="fas fa-chevron-left" aria-hidden=true onmouseover='$("#i-prev").toggle()' onmouseout='$("#i-prev").toggle()'></i></a></li><li><a class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up" aria-hidden=true onmouseover='$("#i-top").toggle()' onmouseout='$("#i-top").toggle()'></i></a></li><li><a class=icon href=# aria-label=Share><i class="fas fa-share-alt" aria-hidden=true onmouseover='$("#i-share").toggle()' onmouseout='$("#i-share").toggle()' onclick='return $("#share").toggle(),!1'></i></a></li></ul><span id=i-prev class=info style=display:none>Previous post</span>
<span id=i-next class=info style=display:none>Next post</span>
<span id=i-top class=info style=display:none>Back to top</span>
<span id=i-share class=info style=display:none>Share post</span></span><br><div id=share style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f" aria-label=Facebook><i class="fab fa-facebook" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&text=wireguard%20mtu%20calculation" aria-label=Twitter><i class="fab fa-twitter" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&title=wireguard%20mtu%20calculation" aria-label=Linkedin><i class="fab fa-linkedin" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&is_video=false&description=wireguard%20mtu%20calculation" aria-label=Pinterest><i class="fab fa-pinterest" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=wireguard%20mtu%20calculation&body=Check out this article: https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f" aria-label=Email><i class="fas fa-envelope" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&title=wireguard%20mtu%20calculation" aria-label=Pocket><i class="fab fa-get-pocket" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&title=wireguard%20mtu%20calculation" aria-label=reddit><i class="fab fa-reddit" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&name=wireguard%20mtu%20calculation&description=wireguard%20header%20overhead%20and%20the%20connection%20problems%20with%20your%20cutted%20off%20mtu%20by%20your%20isp" aria-label=Tumblr><i class="fab fa-tumblr" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&t=wireguard%20mtu%20calculation" aria-label="Hacker News"><i class="fab fa-hacker-news" aria-hidden=true></i></a></li></ul></div></span></div><article class=post itemscope itemtype=http://schema.org/BlogPosting><header><h1 class=posttitle itemprop="name headline">wireguard mtu calculation</h1><div class=meta><div class=postdate><time datetime="2024-06-27 00:00:00 +0000 UTC" itemprop=datePublished>2024-06-27</time></div><div class=article-read-time><i class="far fa-clock"></i>
5 minute read</div><div class=article-tag><i class="fas fa-tag"></i>
<a class=tag-link href=/tags/network rel=tag>network</a>
,
<a class=tag-link href=/tags/security rel=tag>security</a>
,
<a class=tag-link href=/tags/nix rel=tag>nix</a>
,
<a class=tag-link href=/tags/wireguard rel=tag>wireguard</a></div></div></header><div id=toc><nav id=TableOfContents><ul><li><a href=#short>short</a></li><li><a href=#wg-overhead>wg overhead</a></li><li><a href=#mtu-calculation>mtu calculation</a></li><li><a href=#stabilize-your-wg-connection>stabilize your wg connection</a></li><li><a href=#docs>docs</a></li><li><a href=#learned>learned</a></li></ul></nav></div><div class=content itemprop=articleBody><h2 id=short>short</h2><p>when the wireguard protocol is used the mtu size is reduced inside the tunnel.
this can be a problem when your isp cut off your mtu size and you use large packets like the ssh handshake inside a wireguard connection.
this results in a connection that sometimes work and sometimes not.
to enable a stable connection within wireguard and to avoid isp-related problems, the <strong>mtu</strong> should be set to <strong>1380</strong> bytes.</p><h2 id=wg-overhead>wg overhead</h2><p>when a network tunnel encapsulate your traffic you need extra size for the additional headers.
the overhead of the wireguard header are 32 bytes.
additionaly to calculate the complete overhead the size of the ip and transprot protocol is needed.</p><ul><li>20-byte: ipv4 header or 40 byte ipv6 header</li><li>8-byte: udp header</li><li>4-byte: type</li><li>4-byte: key index</li><li>8-byte: nonce</li><li>16-byte: authentication tag</li><li>n-byte: encrypted data</li></ul><p>add this together with the underlying protocols you get the encapsulation overhead of a wireguard connection.</p><ul><li>60 bytes with ipv4 (20+8+4+4+8+16)</li><li>80 bytes with ipv6 (40+8+4+4+8+16)</li></ul><h2 id=mtu-calculation>mtu calculation</h2><p>assuming a standard mtu size of 1500 bytes on ethernet frames the mtu for ipv4 is 1440 (1500-60) bytes and for ipv6 1420 (1500-80) bytes.
if your connection is stable if you set one of these sizes, you have no additional headers and your isp don&rsquo;t add additional headers like <a href=https://www.cloudflare.com/learning/network-layer/what-is-gre-tunneling/>gre</a> for routing, you should fine.</p><p>but in my case i run into trouble. when i start my ssh connection from my homelab through the wg tunnel to one of the servers and use it as a jump host i have no stable connection. You guess it, tunnel in tunnel with ssh handshake.
sometimes wireguard not working, sometimes ssh not established a connection.
time to deep dive in.</p><h2 id=stabilize-your-wg-connection>stabilize your wg connection</h2><p>the first step was to check my ssh configuration for my server and for my client in my nixos module.
i figure out, that when i using a smaler bunch of <strong>KexAlgorithms</strong> and <strong>PublicKeyAccpetedTypes</strong> the connection can be established.
i cut off all unesecary (for me) options.
this is only a snipped of the complete ssh configuration.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># server</span>
</span></span><span style=display:flex><span>services.openssh <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    settings <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    KexAlgorithms <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;curve25519-sha256@libssh.org&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;diffie-hellman-group-exchange-sha256&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    extraConfig <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    PubkeyAcceptedKeyTypes ssh-ed25519-cert-v01@openssh.com,ssh-ed25519
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span><span style=color:#75715e># client</span>
</span></span><span style=display:flex><span>programs.ssh <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># mozilla recomended</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ssh-ed25519-cert-v01@openssh.com,ssh-rsa-cert-v01@openssh.com,ssh-ed25519,ssh-rsa,ecdsa-sha2-nistp521-cert-v01@openssh.com,ecdsa-sha2-nistp384-cert-v01@openssh.com,ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp521,ecdsa-sha2-nistp384,ecdsa-sha2-nistp256</span>
</span></span><span style=display:flex><span>    hostKeyAlgorithms <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;ssh-ed25519&#34;</span> <span style=color:#e6db74>&#34;ssh-rsa&#34;</span> <span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>    pubkeyAcceptedKeyTypes <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;ssh-ed25519&#34;</span> <span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>    knownHosts <span style=color:#f92672>=</span> cfg.knownHosts;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>;
</span></span></code></pre></td></tr></table></div></div><p>but this can not be the real problem because wireguard sometimes not established a stable connection no matter if i use ssh or not. next step was to check the connection from my client to the server.
first i check my routing path to my server from my interface connected to the internet.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tracepath &lt;public server ip&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>1?: <span style=color:#f92672>[</span>LOCALHOST<span style=color:#f92672>]</span>                      pmtu <span style=color:#ae81ff>1500</span>
</span></span><span style=display:flex><span>1:  _gateway                                              1.351ms
</span></span><span style=display:flex><span>1:  _gateway                                              0.914ms
</span></span><span style=display:flex><span>2:  _gateway                                              1.514ms pmtu <span style=color:#ae81ff>1460</span> <span style=color:#75715e># magic happens here</span>
</span></span><span style=display:flex><span>2:  no reply
</span></span><span style=display:flex><span>3:  &lt;gw ip&gt;                                              15.359ms asymm  <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>4:  &lt;gw ip&gt;                                              12.878ms
</span></span><span style=display:flex><span>5:  &lt;gw ip&gt;                                              15.886ms
</span></span></code></pre></td></tr></table></div></div><p>and from my server to my public ip of my homelab, because you must messure the mtu from both sides.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tracepath &lt;public ipv4&gt;
</span></span><span style=display:flex><span> 1?: <span style=color:#f92672>[</span>LOCALHOST<span style=color:#f92672>]</span>                      pmtu <span style=color:#ae81ff>1500</span>
</span></span><span style=display:flex><span> 1:  &lt;gw server hoster&gt;                                    0.763ms
</span></span><span style=display:flex><span> 1:  &lt;gw server hoster&gt;                                   10.803ms
</span></span><span style=display:flex><span> 2:  &lt;gw ip&gt;                                               0.440ms
</span></span><span style=display:flex><span> 3:  &lt;gw ip&gt;                                               3.917ms
</span></span><span style=display:flex><span> 4:  &lt;isp gw ip&gt;                                           4.716ms asymm  <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span> 5:  no reply
</span></span><span style=display:flex><span> 6:  &lt;isp gw ip&gt;                                           4.105ms pmtu <span style=color:#ae81ff>1460</span> <span style=color:#75715e># magic happens again</span>
</span></span></code></pre></td></tr></table></div></div><p>the gateway hop number 2 (first) and hop number 6 (second) reduced the pmtu (path mtu discovery) to 1460 bytes!
on some point my internet provider cut 40 bytes off on some routing instance.</p><p>but how does a reduction in mtu of 40 bytes come about?
my first guess was a additional gre header but the protocol has only 24 bytes overhead, so this must be something else.
after some research i find out that my provider use <a href=https://www.rfc-editor.org/rfc/rfc6333>DS-Lite</a> (Dual Stack Lite) a tunnel protocol to carry ipv4 over a ipv6 network.</p><p>after a look into the <a href=https://www.rfc-editor.org/rfc/rfc6333#section-5.3>rfc</a> things get clear.</p><blockquote><p>&ldquo;Using an encapsulation (IPv4-in-IPv6 or anything else) to carry IPv4
traffic over IPv6 will reduce the effective MTU of the datagram.
Unfortunately, path MTU discovery [RFC1191] is not a reliable method
to deal with this problem.&rdquo;&mldr;
&ldquo;A solution to deal with this problem is for the service provider to
increase the MTU size of all the links between the B4 element and the
AFTR elements by at least 40 bytes to accommodate both the IPv6
encapsulation header and the IPv4 datagram without fragmenting the
IPv6 packet.&rdquo;</p></blockquote><p>with this enlightening insight we can adding the ipv6 header size to the prevoius calculation.
so i substract 40 bytes from potential ipv6 1420 bytes (1420 - 40 = 1380) and get the mtu size to my wireguard interface with ds-lite.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># set the mtu of wg0 interface to 1380</span>
</span></span><span style=display:flex><span>ip link set mtu <span style=color:#ae81ff>1380</span> dev wg0
</span></span></code></pre></td></tr></table></div></div><p>remember, mtu should be the same on both sides so do this configuration on your local wg interface and your wg interface on the other endpoint, in my case my server.</p><p>if you are using nixos, you can set the mtu size in your wireguard configuration like this.</p><div class=highlight><div style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>wireguard.enable <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>    wireguard.interfaces <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      wg0 <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ips <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> <span style=color:#75715e>#&lt;wg ip&gt; ];</span>
</span></span><span style=display:flex><span>        privateKeyFile <span style=color:#f92672>=</span> <span style=color:#75715e># &lt;wg key file&gt;;</span>
</span></span><span style=display:flex><span>        listenPort <span style=color:#f92672>=</span> <span style=color:#75715e>#&lt;port number&gt;;</span>
</span></span><span style=display:flex><span>        peers <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># &lt;your peers&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>        mtu <span style=color:#f92672>=</span> 1380;
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>;
</span></span></code></pre></td></tr></table></div></div><p>now i have this configuration about some month and everything runs smoothly.
i hope it helps you if you have some problems to calculate your mtu for your specific environment.</p><h2 id=docs>docs</h2><ul><li><a href=https://lists.zx2c4.com/pipermail/wireguard/2017-December/002201.html>header and mtu sizes for wireguard</a></li><li><a href=https://wiki.freifunk-franken.de/w/MTU>mtu inside a tunnel</a>, freifunk</li><li><a href=https://gist.github.com/nitred/f16850ca48c48c79bf422e90ee5b9d95>test with iperf3</a></li><li><a href=https://www.wireguard.com/protocol/>wireguard protocol</a></li><li><a href=https://en.wikipedia.org/wiki/Generic_Routing_Encapsulation>generic routing encapsulation - gre</a></li><li><a href=https://www.elektronik-kompendium.de/sites/net/2010211.htm>dual stack lite</a></li><li><a href=https://www.rfc-editor.org/rfc/rfc6333>dslite rfc633</a></li><li><a href=https://www.rfc-editor.org/rfc/rfc6908>dslite rfc6908</a></li><li><a href=https://www.cloudflare.com/learning/network-layer/what-is-mss/>mss</a></li></ul><h2 id=learned>learned</h2><ul><li>net.ipv4.icmp_errors_use_inbound_ifaddr = 1</li><li>pmtu, path mtu discovery</li><li>Today, however, almost everything is sent with a DF flag, so the same now applies to IPv4 as to IPv6 (there is no such flag, packets are NEVER fragmented by routers)</li></ul></div></article><div id=footer-post-container><div id=footer-post><div id=nav-footer style=display:none><ul><li><a href=/>home</a></li><li><a href=/posts>writings</a></li><li><a href=/lib>lib</a></li><li><a href=/tags>tags</a></li><li><a href=/whoami>whoami</a></li></ul></div><div id=share-footer style=display:none><ul><li><a class=icon href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f" aria-label=Facebook><i class="fab fa-facebook fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://twitter.com/share?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&text=wireguard%20mtu%20calculation" aria-label=Twitter><i class="fab fa-twitter fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.linkedin.com/shareArticle?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&title=wireguard%20mtu%20calculation" aria-label=Linkedin><i class="fab fa-linkedin fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://pinterest.com/pin/create/bookmarklet/?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&is_video=false&description=wireguard%20mtu%20calculation" aria-label=Pinterest><i class="fab fa-pinterest fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="mailto:?subject=wireguard%20mtu%20calculation&body=Check out this article: https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f" aria-label=Email><i class="fas fa-envelope fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://getpocket.com/save?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&title=wireguard%20mtu%20calculation" aria-label=Pocket><i class="fab fa-get-pocket fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://reddit.com/submit?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&title=wireguard%20mtu%20calculation" aria-label=reddit><i class="fab fa-reddit fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="http://www.tumblr.com/share/link?url=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&name=wireguard%20mtu%20calculation&description=wireguard%20header%20overhead%20and%20the%20connection%20problems%20with%20your%20cutted%20off%20mtu%20by%20your%20isp" aria-label=Tumblr><i class="fab fa-tumblr fa-lg" aria-hidden=true></i></a></li><li><a class=icon href="https://news.ycombinator.com/submitlink?u=https%3a%2f%2fripx80.de%2fposts%2f06-wg-mtu%2f&t=wireguard%20mtu%20calculation" aria-label="Hacker News"><i class="fab fa-hacker-news fa-lg" aria-hidden=true></i></a></li></ul></div><div id=actions-footer><a id=menu-toggle class=icon href=# onclick='return $("#nav-footer").toggle(),!1' aria-label=Menu><i class="fas fa-bars fa-lg" aria-hidden=true></i> Menu</a>
<a id=share-toggle class=icon href=# onclick='return $("#share-footer").toggle(),!1' aria-label=Share><i class="fas fa-share-alt fa-lg" aria-hidden=true></i> share</a>
<a id=top style=display:none class=icon href=# onclick='$("html, body").animate({scrollTop:0},"fast")' aria-label="Top of Page"><i class="fas fa-chevron-up fa-lg" aria-hidden=true></i> Top</a></div></div></div><footer id=footer><div class=footer-left>Copyright &copy; ripx80</div><div class=footer-right><nav><ul><li><a href=/>home</a></li><li><a href=/posts>writings</a></li><li><a href=/lib>lib</a></li><li><a href=/tags>tags</a></li><li><a href=/whoami>whoami</a></li><li><a href=https://ripx80.de/legal>legal notice</a></li><li><a href=https://ripx80.de/privacy>pricacy policy</a></li></ul></nav></div></footer><div id=cookies>if you use this site you accept the usage of cookies. take a closer look under <a href=https://ripx80.de/privacy>privacy policy</a>
<button id=cookies-btn>accept</button></div><script src=https://ripx80.de/js/custom.js defer></script></div></body><link rel=stylesheet href=/lib/font-awesome/css/all.min.css><script src=/lib/jquery/jquery.min.js></script><script src=/js/main.js></script><script src=/js/code-copy.js></script></html>