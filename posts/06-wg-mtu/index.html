<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=author content="ripx80"><title>wireguard mtu calculation | ripx80 onexec</title>
<link rel=stylesheet href=/css/main.min.70f74d6cc30185fa0ce09360143563220b745deaa17fef658bdb181aea5a5c7d.css integrity="sha256-cPdNbMMBhfoM4JNgFDVjIgt0Xeqhf+9li9sYGupaXH0=" crossorigin=anonymous></head><body><header><a class=mainlink href=/><div class=logo></div><h1>ripx80 onexec</h1></a><nav class=nav><ul><li><a href=/>home</a></li><li><a href=/posts/>blog</a></li><li><a href=/lib>lib</a></li><li><a href=/tags>tags</a></li><li><a href=/whoami>whoami</a></li></ul></nav><section id=about>ripx80&rsquo;s technical thoughts and efforts to remember yesterday</section></header><main><h1 class=blogtitle>wireguard mtu calculation</h1><div class=meta><time datetime=2024-06-27T00:00:00+00:00>2024-06-27</time>
<time datetime=2025-02-17T14:28:34+01:00>| 2025-02-17</time>
<span>| 986</span></div><h2>short</h2><article><p>when the wireguard protocol is used the mtu size is reduced inside the tunnel.
this can be a problem when your isp cut off your mtu size and you use large packets like the ssh handshake inside a wireguard connection.
this results in a connection that sometimes work and sometimes not.
to enable a stable connection within wireguard and to avoid isp-related problems, the <strong>mtu</strong> should be set to <strong>1380</strong> bytes.</p><h2 id=wg-overhead>wg overhead</h2><p>when a network tunnel encapsulate your traffic you need extra size for the additional headers.
the overhead of the wireguard header are 32 bytes.
additionaly to calculate the complete overhead the size of the ip and transprot protocol is needed.</p><ul><li>20-byte: ipv4 header or 40 byte ipv6 header</li><li>8-byte: udp header</li><li>4-byte: type</li><li>4-byte: key index</li><li>8-byte: nonce</li><li>16-byte: authentication tag</li><li>n-byte: encrypted data</li></ul><p>add this together with the underlying protocols you get the encapsulation overhead of a wireguard connection.</p><ul><li>60 bytes with ipv4 (20+8+4+4+8+16)</li><li>80 bytes with ipv6 (40+8+4+4+8+16)</li></ul><h2 id=mtu-calculation>mtu calculation</h2><p>assuming a standard mtu size of 1500 bytes on ethernet frames the mtu for ipv4 is 1440 (1500-60) bytes and for ipv6 1420 (1500-80) bytes.
if your connection is stable if you set one of these sizes, you have no additional headers and your isp don&rsquo;t add additional headers like <a href=https://www.cloudflare.com/learning/network-layer/what-is-gre-tunneling/>gre</a> for routing, you should fine.</p><p>but in my case i run into trouble. when i start my ssh connection from my homelab through the wg tunnel to one of the servers and use it as a jump host i have no stable connection. You guess it, tunnel in tunnel with ssh handshake.
sometimes wireguard not working, sometimes ssh not established a connection.
time to deep dive in.</p><h2 id=stabilize-your-wg-connection>stabilize your wg connection</h2><p>the first step was to check my ssh configuration for my server and for my client in my nixos module.
i figure out, that when i using a smaler bunch of <strong>KexAlgorithms</strong> and <strong>PublicKeyAccpetedTypes</strong> the connection can be established.
i cut off all unesecary (for me) options.
this is only a snipped of the complete ssh configuration.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># server</span>
</span></span><span style=display:flex><span>services.openssh <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    settings <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        KexAlgorithms <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;curve25519-sha256@libssh.org&#34;</span>
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#34;diffie-hellman-group-exchange-sha256&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    extraConfig <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&#39;</span>
</span></span><span style=display:flex><span>    PubkeyAcceptedKeyTypes ssh-ed25519-cert-v01@openssh.com,ssh-ed25519
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#39;&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span><span style=color:#75715e># client</span>
</span></span><span style=display:flex><span>programs.ssh <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># mozilla recomended</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ssh-ed25519-cert-v01@openssh.com,ssh-rsa-cert-v01@openssh.com,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ssh-ed25519,ssh-rsa,ecdsa-sha2-nistp521-cert-v01@openssh.com,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ecdsa-sha2-nistp384-cert-v01@openssh.com,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ecdsa-sha2-nistp256-cert-v01@openssh.com,ecdsa-sha2-nistp521,</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e># ecdsa-sha2-nistp384,ecdsa-sha2-nistp256</span>
</span></span><span style=display:flex><span>    hostKeyAlgorithms <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;ssh-ed25519&#34;</span> <span style=color:#e6db74>&#34;ssh-rsa&#34;</span> <span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>    pubkeyAcceptedKeyTypes <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> <span style=color:#e6db74>&#34;ssh-ed25519&#34;</span> <span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>    knownHosts <span style=color:#f92672>=</span> cfg.knownHosts;
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>;
</span></span></code></pre></div><p>but this can not be the real problem because wireguard sometimes not established a stable connection no matter if i use ssh or not. next step was to check the connection from my client to the server.
first i check my routing path to my server from my interface connected to the internet.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tracepath &lt;public server ip&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>1?: <span style=color:#f92672>[</span>LOCALHOST<span style=color:#f92672>]</span> pmtu <span style=color:#ae81ff>1500</span>
</span></span><span style=display:flex><span>1:  _gateway    1.351ms
</span></span><span style=display:flex><span>1:  _gateway    0.914ms
</span></span><span style=display:flex><span>2:  _gateway    1.514ms pmtu <span style=color:#ae81ff>1460</span> <span style=color:#75715e># magic happens here</span>
</span></span><span style=display:flex><span>2:  no reply
</span></span><span style=display:flex><span>3:  &lt;gw ip&gt;     15.359ms asymm  <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>4:  &lt;gw ip&gt;     12.878ms
</span></span><span style=display:flex><span>5:  &lt;gw ip&gt;     15.886ms
</span></span></code></pre></div><p>and from my server to my public ip of my homelab, because you must messure the mtu from both sides.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tracepath &lt;public ipv4&gt;
</span></span><span style=display:flex><span> 1?: <span style=color:#f92672>[</span>LOCALHOST<span style=color:#f92672>]</span> pmtu <span style=color:#ae81ff>1500</span>
</span></span><span style=display:flex><span> 1:  &lt;gw server hoster&gt; 0.763ms
</span></span><span style=display:flex><span> 1:  &lt;gw server hoster&gt; 10.803ms
</span></span><span style=display:flex><span> 2:  &lt;gw ip&gt;            0.440ms
</span></span><span style=display:flex><span> 3:  &lt;gw ip&gt;            3.917ms
</span></span><span style=display:flex><span> 4:  &lt;isp gw ip&gt;        4.716ms asymm  <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span> 5:  no reply
</span></span><span style=display:flex><span> 6:  &lt;isp gw ip&gt;        4.105ms pmtu <span style=color:#ae81ff>1460</span> <span style=color:#75715e># magic happens again</span>
</span></span></code></pre></div><p>the gateway hop number 2 (first) and hop number 6 (second) reduced the pmtu (path mtu discovery) to 1460 bytes!
on some point my internet provider cut 40 bytes off on some routing instance.</p><p>but how does a reduction in mtu of 40 bytes come about?
my first guess was a additional gre header but the protocol has only 24 bytes overhead, so this must be something else.
after some research i find out that my provider use <a href=https://www.rfc-editor.org/rfc/rfc6333>DS-Lite</a> (Dual Stack Lite) a tunnel protocol to carry ipv4 over a ipv6 network.</p><p>after a look into the <a href=https://www.rfc-editor.org/rfc/rfc6333#section-5.3>rfc</a> things get clear.</p><blockquote><p>&ldquo;Using an encapsulation (IPv4-in-IPv6 or anything else) to carry IPv4
traffic over IPv6 will reduce the effective MTU of the datagram.
Unfortunately, path MTU discovery [RFC1191] is not a reliable method
to deal with this problem.&rdquo;&mldr;
&ldquo;A solution to deal with this problem is for the service provider to
increase the MTU size of all the links between the B4 element and the
AFTR elements by at least 40 bytes to accommodate both the IPv6
encapsulation header and the IPv4 datagram without fragmenting the
IPv6 packet.&rdquo;</p></blockquote><p>with this enlightening insight we can adding the ipv6 header size to the prevoius calculation.
so i substract 40 bytes from potential ipv6 1420 bytes (1420 - 40 = 1380) and get the mtu size to my wireguard interface with ds-lite.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e># set the mtu of wg0 interface to 1380</span>
</span></span><span style=display:flex><span>ip link set mtu <span style=color:#ae81ff>1380</span> dev wg0
</span></span></code></pre></div><p>remember, mtu should be the same on both sides so do this configuration on your local wg interface and your wg interface on the other endpoint, in my case my server.</p><p>if you are using nixos, you can set the mtu size in your wireguard configuration like this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>wireguard.enable <span style=color:#f92672>=</span> true;
</span></span><span style=display:flex><span>    wireguard.interfaces <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>      wg0 <span style=color:#f92672>=</span> <span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>        ips <span style=color:#f92672>=</span> <span style=color:#f92672>[</span> <span style=color:#75715e>#&lt;wg ip&gt; ];</span>
</span></span><span style=display:flex><span>        privateKeyFile <span style=color:#f92672>=</span> <span style=color:#75715e># &lt;wg key file&gt;;</span>
</span></span><span style=display:flex><span>        listenPort <span style=color:#f92672>=</span> <span style=color:#75715e>#&lt;port number&gt;;</span>
</span></span><span style=display:flex><span>        peers <span style=color:#f92672>=</span> <span style=color:#f92672>[</span>
</span></span><span style=display:flex><span>          <span style=color:#75715e># &lt;your peers&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>]</span>;
</span></span><span style=display:flex><span>        mtu <span style=color:#f92672>=</span> 1380;
</span></span><span style=display:flex><span>      <span style=color:#f92672>}</span>;
</span></span><span style=display:flex><span>    <span style=color:#f92672>}</span>;
</span></span></code></pre></div><p>now i have this configuration about some month and everything runs smoothly.
i hope it helps you if you have some problems to calculate your mtu for your specific environment.</p><h2 id=docs>docs</h2><ul><li><a href=https://lists.zx2c4.com/pipermail/wireguard/2017-December/002201.html>header and mtu sizes for wireguard</a></li><li><a href=https://wiki.freifunk-franken.de/w/MTU>mtu inside a tunnel</a>, freifunk</li><li><a href=https://gist.github.com/nitred/f16850ca48c48c79bf422e90ee5b9d95>test with iperf3</a></li><li><a href=https://www.wireguard.com/protocol/>wireguard protocol</a></li><li><a href=https://en.wikipedia.org/wiki/Generic_Routing_Encapsulation>generic routing encapsulation - gre</a></li><li><a href=https://www.elektronik-kompendium.de/sites/net/2010211.htm>dual stack lite</a></li><li><a href=https://www.rfc-editor.org/rfc/rfc6333>dslite rfc633</a></li><li><a href=https://www.rfc-editor.org/rfc/rfc6908>dslite rfc6908</a></li><li><a href=https://www.cloudflare.com/learning/network-layer/what-is-mss/>mss</a></li></ul><h2 id=learned>learned</h2><ul><li>net.ipv4.icmp_errors_use_inbound_ifaddr = 1</li><li>pmtu, path mtu discovery</li><li>Today, however, almost everything is sent with a DF flag, so the same now applies to IPv4 as to IPv6 (there is no such flag, packets are NEVER fragmented by routers)</li></ul></article><div><div>tags:
[<a href=/tags/network/>network</a>]
[<a href=/tags/security/>security</a>]
[<a href=/tags/nix/>nix</a>]
[<a href=/tags/wireguard/>wireguard</a>]</main><footer></footer></body></html>