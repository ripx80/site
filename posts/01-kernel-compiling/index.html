<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes"><meta name=author content="ripx80"><title>Kernel Compiling | ripx80 onexec</title>
<link rel=stylesheet href=/css/main.min.70f74d6cc30185fa0ce09360143563220b745deaa17fef658bdb181aea5a5c7d.css integrity="sha256-cPdNbMMBhfoM4JNgFDVjIgt0Xeqhf+9li9sYGupaXH0=" crossorigin=anonymous></head><body><header><a class=mainlink href=/><div class=logo></div><h1>ripx80 onexec</h1></a><nav class=nav><ul><li><a href=/>home</a></li><li><a href=/posts/>blog</a></li><li><a href=/lib>lib</a></li><li><a href=/tags>tags</a></li><li><a href=/whoami>whoami</a></li></ul></nav><section id=about>ripx80&rsquo;s technical thoughts and efforts to remember yesterday</section></header><main><h1 class=blogtitle>Kernel Compiling</h1><div class=meta><time datetime=2021-12-28T16:46:50+01:00>2021-12-28</time>
<time datetime=2025-02-17T14:28:34+01:00>| 2025-02-17</time>
<span>| 589</span></div><h2>short</h2><article><p>This is a short discurse about self kernel compilation on a arch system. Gentoo users are familiar with this kind of instructions or use the genkernel programm.
You can find an article on <a href=https://wiki.archlinux.org/index.php/Kernels/Traditional_compilation>archlinux</a></p><h2 id=install-kernel-sources-and-headers>Install kernel sources and headers</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>pacman -S base-devel <span style=color:#75715e># only gcc and make</span>
</span></span><span style=display:flex><span>mkdir /usr/src/linux
</span></span><span style=display:flex><span>cd /usr/src/linux
</span></span></code></pre></div><p>download the newest kernel release, at this moment it is 4.13.0</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>wget https://www.kernel.org/pub/linux/kernel/v4.x/linux-4.13.2.tar.xz
</span></span><span style=display:flex><span>wget https://www.kernel.org/pub/linux/kernel/v4.x/linux-4.13.2.tar.sign
</span></span><span style=display:flex><span>wget https://www.kernel.org/pub/linux/kernel/v4.x/sha256sums.asc
</span></span></code></pre></div><p>check the sha256 checksum and decompress the archive and check the sign. you can see the offical key from Greg Kroah-Hartman on the linux website.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>grep <span style=color:#e6db74>&#39;linux-4.13.2.tar.xz&#39;</span> sha256sums.asc
</span></span><span style=display:flex><span>064adc177a384a7aee6b18ef5d47c1cea3a43fae1aaa6aa95fdc97eb137ffcd1<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>linux-4.13.2.tar.xz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>sha256sum linux-4.13.2.tar.xz
</span></span><span style=display:flex><span>064adc177a384a7aee6b18ef5d47c1cea3a43fae1aaa6aa95fdc97eb137ffcd1<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>linux-4.13.2.tar.xz
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>unxz linux-4.13.2.tar.xz
</span></span><span style=display:flex><span>gpg2 --verify linux-4.13.2.tar.sign
</span></span><span style=display:flex><span>gpg2 --keyserver hkp://keys.gnupg.net --recv-keys <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>647F28654894E3BD457199BE38DBBDC86092693E
</span></span></code></pre></div><p>when everything looks good continue with this steps</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tar -xpf linux-4.13.2.tar
</span></span><span style=display:flex><span>ln -s linux-4.13.2 linux;cd linux
</span></span></code></pre></div><h2 id=kernel-configuration-and-compiling>Kernel configuration and compiling</h2><p>Now we are in the kernel source tree. clean up the tree is a good thing to begin :-)
if you have a kernel .config copy it to a save place.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make clean <span style=color:#f92672>&amp;&amp;</span> make mrproper
</span></span></code></pre></div><p>Now the work begin to configure your specific kernel config. this will be saved in .config file in your kernel base dir. A good begin is to use your previously hand made config or use the current running:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>make localmodconfig
</span></span><span style=display:flex><span><span style=color:#75715e># or the running arch config</span>
</span></span><span style=display:flex><span>zcat /proc/config.gz &gt; .config
</span></span></code></pre></div><p>you will be asked about the new features. if you unsure use the default.
after this a .config will be created in your kernel base dir. Now its time for you!
use the old way with</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cp .config ../config-default
</span></span><span style=display:flex><span>make menuconfig
</span></span></code></pre></div><p>or the new interface</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span> make nconfig
</span></span></code></pre></div><p>After edit your configuration (super-slim config of my computer will to be download at the end of this article) buid your kernel. But before we install the modules we change the version of our Kernel in the Makefile. We will increase this number if we build a new kernel. So we have no conflicts with the modules&mldr; (-j NUMBER, is for the number of cores in your computer)</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#nano -w Makefile</span>
</span></span><span style=display:flex><span>EXTRAVERSION <span style=color:#f92672>=</span> -acr-1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make -j3; make modules_install
</span></span></code></pre></div><h2 id=setting-up-your-boot-environment>Setting up your boot environment</h2><p>When your compile process was successful you will be copy your kernel to your /boot folder (64-bit system). While I have a full encrypted system I need a ramdisk to open my partitions before I boot the initial system. So lets copy and make a ramdisk with the correct modules.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cp arch/x86_64/boot/bzImage /boot/kernel-4.13.2-acr-1
</span></span><span style=display:flex><span>mkinitcpio -k 4.13.2-acr-1-ARCH -g /boot/initramfs-linux-4.13.img
</span></span></code></pre></div><p>And change your boot menu. I used the syslinux boot-manager. So my menu config looks like this.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#75715e>#nano -w /boot/syslinux/syslinux.cfg#</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>LABEL arch-4.13.2-atr-1
</span></span><span style=display:flex><span>    LINUX ../kernel-4.13.2-atr-1
</span></span><span style=display:flex><span>    APPEND root<span style=color:#f92672>=</span>/dev/mapper/crypt cryptdevice<span style=color:#f92672>=</span>/dev/sda3:crypt<span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>    rootflags<span style=color:#f92672>=</span>subvol<span style=color:#f92672>=</span>__active/root rw intel_iommu<span style=color:#f92672>=</span>on amd_iommu<span style=color:#f92672>=</span>on
</span></span><span style=display:flex><span>    INITRD ../initramfs-linux-4.13.img
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>syslinux-install_update -iam
</span></span></code></pre></div><p>And now reboot. If all is correct you will be get the password prompt of the crypt device and you systems boot correctly. But when you look of the size of your kernel&mldr;</p><h2 id=optimize-your-kernel-settings>Optimize your kernel settings</h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>du -sh kernel-4.13.2-acr-1-ARCH initramfs-linux-4.13.img
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>5.2M    kernel-4.13.2-acr-1-ARCH
</span></span><span style=display:flex><span>4.8M    initramfs-linux-4.13.img
</span></span></code></pre></div><p>This is not the optimization you want to. Its time to optimize your kernel needs.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>cd /usr/src/linux/linux
</span></span><span style=display:flex><span>make mrproper
</span></span><span style=display:flex><span>cp ../config-default ./.config
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#nano -w Makefile</span>
</span></span><span style=display:flex><span>EXTRAVERSION <span style=color:#f92672>=</span> -acr-2
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>make nconfig
</span></span></code></pre></div><p>Now you deselect all the options you doesn&rsquo;t need for you computer and your setup.
Sometimes its a difficult thing but when you look in the description of a kernel feature you will get an recommendation what you should do:</p><p>If you don&rsquo;t know what this means you don&rsquo;t need it.
or</p><p>This is generally a good idea, so say Y.</p><p>Get you a smaller kernel size like 1MB? Its you challange&mldr;</p></article><div><div>tags:
[<a href=/tags/arch/>arch</a>]
[<a href=/tags/optimization/>optimization</a>]
[<a href=/tags/security/>security</a>]</main><footer></footer></body></html>